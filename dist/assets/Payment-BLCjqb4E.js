import{o as F,p as J,u as _,r as i,j as e,q as Y,m as w,t as A,I as k,v as T,d as U,e as H,E as Z}from"./index-BsN2_pnW.js";import{C}from"./credit-card-DO2M7p6S.js";import{A as W}from"./alert-circle-SvOm7kvH.js";import{C as M}from"./check-circle-UCtte7y5.js";import{A as X}from"./arrow-left-D92mxbb0.js";import{I as G}from"./info-SxYLStHm.js";const V="https://jamgmyljyydryxaonbgk.supabase.co",Q="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphbWdteWxqeXlkcnl4YW9uYmdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIxMzUwNTIsImV4cCI6MjA1NzcxMTA1Mn0.N3v4C2PtSuW_VZ9ngyyjEMC06brPchLL4r8bsMjwXic";async function K(o){try{const a=await fetch(`${V}/functions/v1/create-payment`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Q}`},body:JSON.stringify(o)});if(!a.ok){const r=await a.json();throw new Error(r.error||"Failed to create payment intent")}return await a.json()}catch(a){throw console.error("Error creating payment intent:",a),a}}const ee=({clientSecret:o,amount:a,orderNumber:r,onSuccess:b,onError:m})=>{const n=F(),f=J(),g=_(),[v,t]=i.useState(null),[j,u]=i.useState(!1),[c,x]=i.useState(!1),[P,O]=i.useState(!1),[q,R]=i.useState(!1),[d,S]=i.useState("card"),[N,E]=i.useState({name:"",email:""}),[I,D]=i.useState(null);i.useEffect(()=>{if(n){const l=n.paymentRequest({country:"NL",currency:"eur",total:{label:`Order #${r}`,amount:Math.round(a*100)},requestPayerName:!0,requestPayerEmail:!0});l.canMakePayment().then(h=>{h&&D(l)}),l.on("paymentmethod",async h=>{u(!0);try{const{error:p,paymentIntent:s}=await n.confirmCardPayment(o,{payment_method:h.paymentMethod.id},{handleActions:!1});if(p){h.complete("fail"),t(p.message||"Payment failed"),u(!1);return}if(h.complete("success"),s.status==="requires_action"){const{error:y}=await n.confirmCardPayment(o);if(y){t(y.message||"Payment failed"),u(!1);return}}x(!0),b&&b(s.id),g("/checkout/success",{state:{orderNumber:r,totalAmount:a,estimatedDelivery:new Date(Date.now()+864e5).toISOString()}})}catch(p){console.error("Payment error:",p),t("An unexpected error occurred. Please try again."),m&&m(p)}u(!1)})}},[n,a,r,o,g,b,m]);const z=async l=>{var h,p;if(l.preventDefault(),!(!n||!f)){if(d==="card"&&!P){t("Please complete your card details");return}if(d==="ideal"&&!q){t("Please select your bank");return}u(!0),t(null);try{let s;if(d==="card"){const y=f.getElement(A);if(!y){t("Card element not found"),u(!1);return}s=await n.confirmCardPayment(o,{payment_method:{card:y,billing_details:N}})}else if(d==="ideal"){const y=f.getElement(k);if(!y){t("iDEAL element not found"),u(!1);return}s=await n.confirmIdealPayment(o,{payment_method:{ideal:y,billing_details:{name:"",email:""}},return_url:`${window.location.origin}/checkout/success`})}s!=null&&s.error?(t(s.error.message||"An error occurred during payment"),m&&m(new Error(s.error.message||"Payment failed"))):((h=s==null?void 0:s.paymentIntent)==null?void 0:h.status)==="succeeded"?(x(!0),b&&b(s.paymentIntent.id),g("/checkout/success",{state:{orderNumber:r,totalAmount:a,estimatedDelivery:new Date(Date.now()+864e5).toISOString()}})):((p=s==null?void 0:s.paymentIntent)==null?void 0:p.status)==="processing"&&console.log("Payment processing, redirecting...")}catch(s){console.error("Payment error:",s),t("An unexpected error occurred. Please try again."),m&&m(s)}u(!1)}},L={style:{base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}}},B={style:{base:{padding:"10px 12px",color:"#32325d",fontSize:"16px","::placeholder":{color:"#aab7c4"}}}},$={style:{paymentRequestButton:{type:"default",theme:"dark",height:"48px"}}};return e.jsxs("form",{onSubmit:z,className:"space-y-6",children:[I&&e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Express Checkout"}),e.jsx("div",{className:"p-0 rounded-xl",children:e.jsx(Y,{options:{paymentRequest:I,style:$.style}})}),e.jsx("div",{className:"mt-4 text-center text-sm text-gray-500",children:"Or pay with card or iDEAL"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Payment Method"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs(w.button,{type:"button",onClick:()=>S("card"),className:`flex items-center justify-center p-4 rounded-xl border ${d==="card"?"border-blue-500 bg-blue-50":"border-gray-300 bg-white hover:bg-gray-50"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:[e.jsx(C,{className:`w-6 h-6 mr-2 ${d==="card"?"text-blue-600":"text-gray-500"}`}),e.jsx("span",{className:d==="card"?"font-medium text-blue-700":"text-gray-700",children:"Credit Card"})]}),e.jsx(w.button,{type:"button",onClick:()=>S("ideal"),className:`flex items-center justify-center p-4 rounded-xl border ${d==="ideal"?"border-blue-500 bg-blue-50":"border-gray-300 bg-white hover:bg-gray-50"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsx("span",{className:d==="ideal"?"font-medium text-blue-700":"text-gray-700",children:"iDEAL"})})]})]}),e.jsxs("div",{className:"space-y-4",children:[d==="card"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Card Details"}),e.jsx("div",{className:"p-4 border border-gray-300 rounded-xl bg-white",children:e.jsx(A,{options:L,onChange:l=>O(l.complete)})})]}),d==="ideal"&&e.jsx("div",{children:e.jsx("div",{className:"p-4 border border-gray-300 rounded-xl bg-white",children:e.jsx(k,{options:B,onChange:l=>R(l.complete)})})}),d==="card"&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Name on Card"}),e.jsx("input",{type:"text",value:N.name,onChange:l=>E({...N,name:l.target.value}),required:!0,className:"w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200",placeholder:"Enter cardholder name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Email"}),e.jsx("input",{type:"email",value:N.email,onChange:l=>E({...N,email:l.target.value}),required:!0,className:"w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200",placeholder:"Enter email address"})]})]})]}),v&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(W,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-red-800 mb-1",children:"Payment Error"}),e.jsx("p",{className:"text-red-700 text-sm",children:v})]})]})}),c&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(M,{className:"w-5 h-5 text-green-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-green-800 mb-1",children:"Payment Successful"}),e.jsx("p",{className:"text-green-700 text-sm",children:"Your payment has been processed successfully."})]})]})}),e.jsx(w.button,{type:"submit",disabled:!n||j||c,className:`w-full flex items-center justify-center px-6 py-3 rounded-xl font-medium transition-all duration-300 ${!n||j||c?"bg-gray-400 text-white cursor-not-allowed":"bg-blue-600 text-white shadow-lg hover:shadow-xl"}`,whileHover:!n||j||c?{}:{scale:1.02},whileTap:!n||j||c?{}:{scale:.98},children:j?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"}),"Processing..."]}):c?e.jsxs("div",{className:"flex items-center",children:[e.jsx(M,{className:"w-5 h-5 mr-2"}),"Payment Successful"]}):e.jsxs("div",{className:"flex items-center",children:[e.jsx(C,{className:"w-5 h-5 mr-2"}),"Pay €",a.toFixed(2)]})})]})},te=T("pk_live_51R6eNnGjEEP5GQRt9wiaBUJagG6RnARl5VwyfbI7zSPB8MpR06fzSeZNFrhvMoBcam61UFHLcDaMatEiqnZc4lJd00qRMDSr1Y"),oe=()=>{const o=_(),a=U(),{user:r}=H(),[b,m]=i.useState(!0),[n,f]=i.useState(null),[g,v]=i.useState(null),t=a.state;i.useEffect(()=>{if(!r){o("/login");return}if(!t||!t.orderNumber){o("/account/orders");return}(async()=>{try{m(!0),f(null);const x={amount:t.totalAmount,currency:"eur",description:`Order #${t.orderNumber}`,metadata:{orderNumber:t.orderNumber,customerName:`${(r==null?void 0:r.user_metadata.first_name)||""} ${(r==null?void 0:r.user_metadata.last_name)||""}`.trim(),email:(r==null?void 0:r.email)||""}},{clientSecret:P}=await K(x);v(P)}catch(x){console.error("Error creating payment intent:",x),f(x instanceof Error?x.message:"Failed to initialize payment")}finally{m(!1)}})()},[r,t,o]);const j=c=>{console.log("Payment successful:",c)},u=c=>{console.error("Payment error:",c),f(c.message)};return b?e.jsx("div",{className:"min-h-screen pt-24 pb-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-b from-gray-50 to-white",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Initializing payment..."})]})})}):e.jsx("div",{className:"min-h-screen pt-24 pb-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-b from-gray-50 to-white",children:e.jsxs("div",{className:"max-w-3xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsx(w.button,{onClick:()=>o(-1),className:"text-gray-600 hover:text-gray-900",whileHover:{x:-5},children:e.jsx(X,{className:"w-6 h-6"})}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Complete Your Payment"})]}),e.jsxs("p",{className:"text-gray-600",children:["Order #",t==null?void 0:t.orderNumber]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Payment Summary"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Order Number"}),e.jsx("span",{className:"text-gray-700 font-medium",children:t==null?void 0:t.orderNumber})]}),e.jsx("div",{className:"border-t border-gray-200 pt-3 mt-3",children:e.jsxs("div",{className:"flex justify-between items-center font-medium",children:[e.jsx("span",{className:"text-gray-800",children:"Total Amount"}),e.jsxs("span",{className:"text-xl text-gray-900",children:["€",t==null?void 0:t.totalAmount.toFixed(2)]})]})})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center",children:[e.jsx(C,{className:"w-5 h-5 mr-2 text-blue-600"}),"Payment Details"]}),g?e.jsx(Z,{stripe:te,options:{clientSecret:g,appearance:{theme:"stripe",variables:{colorPrimary:"#2563eb"}}},children:e.jsx(ee,{clientSecret:g,amount:t.totalAmount,orderNumber:t.orderNumber,onSuccess:j,onError:u})}):e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(G,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-red-800 mb-1",children:"Payment Error"}),e.jsx("p",{className:"text-red-700 text-sm",children:n||"Unable to initialize payment. Please try again."})]})]})})]}),e.jsxs("div",{className:"bg-blue-50 rounded-xl p-5",children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-3",children:"Secure Payment"}),e.jsx("p",{className:"text-blue-700 text-sm",children:"Your payment information is securely processed by Stripe. We never store your full card details on our servers."})]})]})})};export{oe as default};
