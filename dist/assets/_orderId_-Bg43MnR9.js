import{s as c,l as Y,u as R,e as Q,r as p,j as e,m as _,i as $,b as P,A as z,X as B,g as A}from"./index-BsN2_pnW.js";import{A as M}from"./arrow-left-D92mxbb0.js";import{I as J}from"./info-SxYLStHm.js";import{E as V}from"./external-link-DUhWncxF.js";import{P as X}from"./plus-D7P7M6iB.js";import{M as G}from"./minus-Q7ZlvDMF.js";async function K(i,n){try{console.log(`Confirming item discrepancy for order ${i} with decision: ${n}`);const{data:o,error:N}=await c.from("orders").select("status, facility_updated_items").eq("id",i).single();if(N)throw console.error("Error fetching order:",N),N;if(!o)throw console.error("Order not found"),new Error("Order not found");if(o.status!=="pending_item_confirmation")throw console.error("Order is not awaiting item confirmation:",o.status),new Error("Order is no longer awaiting item confirmation");if(n==="accepted"){const{data:m,error:x}=await c.from("discrepancy_items").select(`
          *,
          original_order_item:original_order_item_id (
            product_id,
            service_id,
            service_name,
            category_id,
            category_name
          )
        `).eq("order_id",i);if(x)throw console.error("Error fetching discrepancy items:",x),x;if(console.log("Existing discrepancy items:",m),m&&m.length>0)for(const t of m){if(t.is_temporary){const{error:a}=await c.from("discrepancy_items").update({is_temporary:!1}).eq("id",t.id);if(a)throw console.error("Error updating discrepancy item:",a),a}const{data:v,error:g}=await c.from("order_items").select("id").eq("order_id",i).eq("product_name",t.product_name).maybeSingle();if(g)throw console.error("Error checking existing item:",g),g;if(v){const{error:a}=await c.from("order_items").update({quantity:t.actual_quantity,subtotal:(t.unit_price||0)*t.actual_quantity}).eq("id",v.id);if(a)throw console.error("Error updating order item:",a),a}else{let a=null;if(t.product_id){const{data:b}=await c.from("items").select("id").eq("id",t.product_id).maybeSingle();b?a=t.product_id:console.warn(`Product ID ${t.product_id} not found in items table`)}if(!a&&t.original_order_item&&t.original_order_item.product_id){const{data:b}=await c.from("items").select("id").eq("id",t.original_order_item.product_id).maybeSingle();b?a=t.original_order_item.product_id:console.warn(`Product ID ${t.original_order_item.product_id} from original order item not found in items table`)}if(!a){console.error(`No valid product_id found for discrepancy item ${t.id}, skipping`);continue}const{error:j}=await c.from("order_items").insert({order_id:i,product_id:a,product_name:t.product_name,quantity:t.actual_quantity,unit_price:t.unit_price||0,subtotal:(t.unit_price||0)*t.actual_quantity,service_type:t.service_type,category_name:t.category_name||(t.original_order_item?t.original_order_item.category_name:null),service_name:t.service_name||(t.original_order_item?t.original_order_item.service_name:null),service_id:t.service_id||(t.original_order_item?t.original_order_item.service_id:null),category_id:t.category_id||(t.original_order_item?t.original_order_item.category_id:null),is_facility_added:!0});if(j)throw console.error("Error inserting order item:",j),console.error("Failed item data:",{order_id:i,product_id:a,product_name:t.product_name,quantity:t.actual_quantity,unit_price:t.unit_price||0,service_id:t.service_id||(t.original_order_item?t.original_order_item.service_id:null),category_id:t.category_id||(t.original_order_item?t.original_order_item.category_id:null)}),j}}}const w=n==="accepted"?{customer_item_decision:n,status:"processing"}:{customer_item_decision:n,status:"processing"},{data:d,error:y}=await c.from("orders").update(w).eq("id",i).select().single();if(y)throw console.error("Error updating order decision:",y),y;return console.log("Order updated successfully:",d),d}catch(o){throw console.error("Error confirming item discrepancy:",o),o}}const ae=()=>{const{orderId:i}=Y(),n=R(),{user:o}=Q(),[N,w]=p.useState(!0),[d,y]=p.useState(!1),[m,x]=p.useState(null),[t,v]=p.useState(null),[g,a]=p.useState([]),[j,b]=p.useState([]),[q,H]=p.useState([]),[u,U]=p.useState(null);p.useEffect(()=>{if(!o){localStorage.setItem("returnTo",`/orders/item-confirmation/${i}`),n("/login");return}if(!i){x("Order ID is missing"),w(!1);return}L()},[o,i,n]);const L=async()=>{var r;try{w(!0),x(null),console.log("Fetching order details for order ID:",i);const{data:s,error:l}=await c.from("orders").select(`
          *,
          order_items (*)
        `).eq("id",i).single();if(l)throw console.error("Error fetching order:",l),l;if(!s)throw console.error("Order not found"),new Error("Order not found");if(console.log("Order data:",s),s.user_id!==(o==null?void 0:o.id))throw console.error("Unauthorized: Order user_id does not match current user"),new Error("Unauthorized");if(s.status!=="pending_item_confirmation")throw console.error("Order is not in pending_item_confirmation state:",s.status),new Error("Order is not awaiting item confirmation");const{data:E,error:S}=await c.from("discrepancy_items").select(`
          *,
          original_order_item:original_order_item_id (
            product_id,
            service_id,
            service_name,
            category_id,
            category_name
          )
        `).eq("order_id",i);if(S)throw console.error("Error fetching discrepancy items:",S),S;if(console.log("Discrepancy items:",E),v(s),a(s.order_items||[]),H(E||[]),s.facility_updated_items){const O=typeof s.facility_updated_items=="string"?JSON.parse(s.facility_updated_items):s.facility_updated_items;if(!Array.isArray(O))console.warn("facility_updated_items is not an array:",O),b([]);else{console.log("Updated items list:",O);const I=O.map(f=>{var k;const h=(k=s.order_items)==null?void 0:k.find(W=>W.product_id===f.product_id);return{...f,quantity_difference:f.quantity-((h==null?void 0:h.quantity)||0)}});b(I);const F=((r=s.order_items)==null?void 0:r.reduce((f,h)=>f+h.unit_price*h.quantity,0))||0,T=I.reduce((f,h)=>f+h.unit_price*h.quantity,0);U({originalTotal:F,newTotal:T,difference:T-F})}}}catch(s){console.error("Error fetching order:",s),x(s instanceof Error?s.message:"Failed to load order")}finally{w(!1)}},C=async r=>{try{if(y(!0),x(null),!i)throw new Error("Order ID is required");await K(i,r),n("/account/orders",{state:{message:r==="accepted"?"You have approved the updated items. Your order is now being processed.":"You have declined the updated items. Your order will be processed with the original items."}})}catch(s){console.error("Error updating decision:",s),x(s instanceof Error?s.message:"Failed to update decision"),y(!1)}},D=r=>r>0?e.jsx(X,{className:"w-4 h-4 text-green-600"}):r<0?e.jsx(G,{className:"w-4 h-4 text-red-600"}):e.jsx(A,{className:"w-4 h-4 text-blue-600"});return N?e.jsx("div",{className:"min-h-screen pt-24 pb-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-b from-gray-50 to-white",children:e.jsxs("div",{className:"max-w-3xl mx-auto text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading order details..."})]})}):m?e.jsx("div",{className:"min-h-screen pt-24 pb-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-b from-gray-50 to-white",children:e.jsx("div",{className:"max-w-3xl mx-auto text-center",children:e.jsxs("div",{className:"bg-red-50 rounded-xl p-6 border border-red-100",children:[e.jsx("h2",{className:"text-xl font-bold text-red-700 mb-2",children:"Error"}),e.jsx("p",{className:"text-red-600 mb-4",children:m}),e.jsx(_.button,{onClick:()=>n("/account/orders"),className:"px-4 py-2 bg-red-600 text-white rounded-lg",whileHover:{scale:1.05},whileTap:{scale:.95},children:"Back to Orders"})]})})}):t?e.jsx("div",{className:"min-h-screen pt-24 pb-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-b from-gray-50 to-white",children:e.jsxs("div",{className:"max-w-3xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsx(_.button,{onClick:()=>n("/account/orders"),className:"text-gray-600 hover:text-gray-900",whileHover:{x:-5},children:e.jsx(M,{className:"w-6 h-6"})}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Item Discrepancy Review"})]}),e.jsxs("p",{className:"text-gray-600",children:["Order #",t.order_number]})]}),e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx($,{className:"w-5 h-5 text-amber-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-amber-800 mb-1",children:"Item Confirmation Needed"}),e.jsx("p",{className:"text-amber-700 text-sm",children:"We found a difference between the items you submitted and the items received by our facility. Please review the updated list below and confirm so we can begin cleaning."})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"What You Ordered"}),e.jsx("div",{className:"space-y-4",children:g.length>0?g.map(r=>e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:r.product_name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Quantity: ",r.quantity]}),r.service_name&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Service: ",r.service_name]}),r.category_name&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Category: ",r.category_name]})]}),e.jsxs("p",{className:"font-medium text-gray-900",children:["€",(r.unit_price*r.quantity).toFixed(2)]})]},r.id)):e.jsx("p",{className:"text-gray-500 italic",children:"No original items found"})})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"What We Received"}),e.jsx("div",{className:"space-y-4",children:q.length>0?q.map(r=>{const s=g.find(E=>E.id===r.original_order_item_id),l=r.actual_quantity-(r.expected_quantity||(s==null?void 0:s.quantity)||0);return e.jsxs("div",{className:`flex justify-between items-start ${l!==0?"bg-yellow-50 p-4 rounded-lg":""}`,children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"mr-2",children:D(l)}),e.jsx("p",{className:"font-medium text-gray-900",children:r.product_name})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Quantity: ",r.actual_quantity]}),l!==0&&e.jsxs("span",{className:`text-sm ${l>0?"text-green-600":"text-red-600"}`,children:["(",l>0?"+":"",l,")"]})]}),r.service_name&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Service: ",r.service_name]}),r.category_name&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Category: ",r.category_name]}),r.notes&&e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:r.notes})]})]}),e.jsxs("p",{className:"font-medium text-gray-900",children:["€",((r.unit_price||0)*r.actual_quantity).toFixed(2)]})]},r.id)}):j.length>0?j.map(r=>e.jsxs("div",{className:`flex justify-between items-start ${r.quantity_difference!==0?"bg-yellow-50 p-4 rounded-lg":""}`,children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"mr-2",children:D(r.quantity_difference)}),e.jsx("p",{className:"font-medium text-gray-900",children:r.product_name})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Quantity: ",r.quantity]}),r.quantity_difference!==0&&e.jsxs("span",{className:`text-sm ${r.quantity_difference>0?"text-green-600":"text-red-600"}`,children:["(",r.quantity_difference>0?"+":"",r.quantity_difference,")"]})]}),r.service_name&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Service: ",r.service_name]}),r.category_name&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Category: ",r.category_name]})]})]}),e.jsxs("p",{className:"font-medium text-gray-900",children:["€",(r.unit_price*r.quantity).toFixed(2)]})]},`${r.product_id}`)):e.jsx("p",{className:"text-gray-500 italic",children:"No discrepancy information available"})})]})]}),t.facility_notes&&e.jsxs("div",{className:"bg-blue-50 rounded-xl p-6 mb-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-2 flex items-center",children:[e.jsx(J,{className:"w-5 h-5 text-blue-600 mr-2"}),"Facility Comment"]}),e.jsx("p",{className:"text-gray-700 whitespace-pre-line",children:t.facility_notes})]}),u&&u.difference!==0&&e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Updated Price Summary"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Original Subtotal"}),e.jsxs("span",{className:"text-gray-700",children:["€",u.originalTotal.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"New Subtotal"}),e.jsxs("span",{className:"text-gray-700",children:["€",u.newTotal.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"VAT (21%)"}),e.jsxs("span",{className:"text-gray-700",children:["€",(u.newTotal*.21).toFixed(2)]})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-3 mt-3",children:[e.jsxs("div",{className:"flex justify-between items-center font-medium",children:[e.jsx("span",{className:"text-gray-800",children:"Updated Total"}),e.jsxs("span",{className:"text-lg text-gray-900",children:["€",(u.newTotal*1.21).toFixed(2)]})]}),e.jsx("div",{className:"flex justify-end mt-1",children:e.jsxs("span",{className:`text-sm ${u.difference>0?"text-red-600":"text-green-600"}`,children:[u.difference>0?"+":"","€",u.difference.toFixed(2)," difference"]})})]})]})]}),t.item_discrepancy_photo_url&&e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center",children:[e.jsx(P,{className:"w-5 h-5 text-gray-700 mr-2"}),"Photo Evidence"]}),e.jsxs("div",{className:"relative aspect-video rounded-lg overflow-hidden bg-gray-100",children:[e.jsx("img",{src:t.item_discrepancy_photo_url,alt:"Item discrepancy evidence",className:"absolute inset-0 w-full h-full object-contain"}),e.jsx(_.a,{href:t.item_discrepancy_photo_url,target:"_blank",rel:"noopener noreferrer",className:"absolute top-2 right-2 p-2 bg-white/80 rounded-lg hover:bg-white",whileHover:{scale:1.05},whileTap:{scale:.95},children:e.jsx(V,{className:"w-5 h-5 text-gray-600"})})]})]}),q.some(r=>r.photo_url)&&e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center",children:[e.jsx(P,{className:"w-5 h-5 text-gray-700 mr-2"}),"Item Photos"]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:q.filter(r=>r.photo_url).map(r=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"aspect-video rounded-lg overflow-hidden bg-gray-100",children:e.jsx("img",{src:r.photo_url||"",alt:`${r.product_name} evidence`,className:"w-full h-full object-contain"})}),e.jsx("div",{className:"absolute bottom-2 left-2 right-2 bg-black/50 text-white text-sm p-2 rounded",children:r.product_name})]},`photo-${r.id}`))})]}),e.jsx(z,{children:m&&e.jsx(_.div,{className:"bg-red-50 border border-red-200 rounded-xl p-4 mb-6",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:e.jsxs("div",{className:"flex items-start",children:[e.jsx($,{className:"w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-red-800 mb-1",children:"Error"}),e.jsx("p",{className:"text-red-700 text-sm",children:m})]})]})})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-end",children:[e.jsx(_.button,{onClick:()=>C("declined"),disabled:d,className:"flex items-center justify-center px-6 py-3 bg-red-600 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed",whileHover:{scale:d?1:1.05},whileTap:{scale:d?1:.95},children:d?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"w-5 h-5 mr-2"}),"Reject Changes"]})}),e.jsx(_.button,{onClick:()=>C("accepted"),disabled:d,className:"flex items-center justify-center px-6 py-3 bg-green-600 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed",whileHover:{scale:d?1:1.05},whileTap:{scale:d?1:.95},children:d?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"w-5 h-5 mr-2"}),"Approve Changes"]})})]})]})}):e.jsx("div",{className:"min-h-screen pt-24 pb-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-b from-gray-50 to-white",children:e.jsx("div",{className:"max-w-3xl mx-auto text-center",children:e.jsxs("div",{className:"bg-red-50 rounded-xl p-6 border border-red-100",children:[e.jsx("h2",{className:"text-xl font-bold text-red-700 mb-2",children:"Order Not Found"}),e.jsx("p",{className:"text-red-600 mb-4",children:"The requested order could not be found."}),e.jsx(_.button,{onClick:()=>n("/account/orders"),className:"px-4 py-2 bg-red-600 text-white rounded-lg",whileHover:{scale:1.05},whileTap:{scale:.95},children:"Back to Orders"})]})})})};export{ae as default};
